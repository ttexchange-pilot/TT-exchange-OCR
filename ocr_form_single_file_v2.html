<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCR ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</title>
  <style>
    :root{ --maxw: 980px; --gap: 12px; --radius: 12px; --shadow: 0 6px 18px rgba(0,0,0,.08); --border: 1px solid #e5e7eb; }
    *{ box-sizing: border-box; }
    body{ font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, 'Noto Sans Thai', sans-serif; margin:0; background:#f7fafc; color:#111827; }
    header{ position:sticky; top:0; z-index:10; background:white; box-shadow: var(--shadow); padding:14px 16px; }
    header .wrap{ max-width: var(--maxw); margin:0 auto; display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    header h1{ font-size:18px; margin:0; }
    main{ max-width: var(--maxw); margin:20px auto; padding: 0 16px 80px; }
    .card{ background:white; border-radius: var(--radius); box-shadow: var(--shadow); border: var(--border); padding:16px; margin-bottom:16px; }
    .grid{ display:grid; gap: var(--gap); grid-template-columns: repeat(12, 1fr); }
    .col-12{ grid-column: span 12; } .col-6{ grid-column: span 6; } .col-4{ grid-column: span 4; }
    @media (max-width: 860px){ .col-6,.col-4{ grid-column: span 12; } }
    label{ display:block; font-weight:600; margin-bottom:6px; }
    input[type="text"], input[type="date"], textarea, select { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; outline:none; }
    textarea{ min-height:100px; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; background:#111827; color:white; cursor:pointer; text-decoration:none; }
    .btn.secondary{ background:white; color:#111827; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; }
    .hint{ font-size:12px; color:#6b7280; margin-top:6px; }
    .preview{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .preview img, .preview canvas{ max-width:300px; width:100%; border-radius:10px; border:1px solid #e5e7eb; background:#f3f4f6; }
    .log{ background:#0b1021; color:#d1e7ff; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; padding:12px; border-radius:10px; min-height:140px; white-space:pre-wrap; overflow:auto; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    video{ width:100%; max-width:300px; border-radius:10px; border:1px solid #e5e7eb; background:#000; }
    .footer{ position:fixed; bottom:0; left:0; right:0; background:white; box-shadow: var(--shadow); padding:10px 16px; }
    .footer .wrap{ max-width: var(--maxw); margin:0 auto; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .kbd{ background:#111827; color:#fff; padding:2px 6px; border-radius:6px; font-size:12px; }
    .table{ width:100%; border-collapse: collapse; } .table th,.table td{ border:1px solid #e5e7eb; padding:8px; font-size:14px; } .table th{ background:#f8fafc; text-align:left; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="badge">v2</div>
      <h1>OCR ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‚Äî ‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="grid">
        <div class="col-12">
          <div class="toolbar">
            <label class="btn">
              <input type="file" id="fileInput" accept="image/*;capture=camera" capture="environment" style="display:none" />
              üì∑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÑ‡∏ü‡∏•‡πå)
            </label>
            <button class="btn secondary" id="openCam">üé• ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button class="btn secondary" id="snapBtn" disabled>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
            <button class="btn" id="runBtn" disabled>üß† ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR</button>
            <button class="btn secondary" id="clearBtn">üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
          </div>
          <div class="hint">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ iPhone: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
        </div>

        <div class="col-12">
          <div class="preview">
            <video id="video" playsinline muted></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="previewImg" alt="preview" />
            <div style="flex:1; min-width:260px;">
              <div class="row" style="margin-bottom:6px;">
                <span class="badge">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                <span id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°</span>
              </div>
              <div class="log" id="logBox"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="margin-bottom: 8px;">
        <span class="badge">‡∏ü‡∏≠‡∏£‡πå‡∏°</span>
        <span class="hint">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Äî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </div>
      <div class="grid">
        <div class="col-6"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label><select id="docType"><option value="">Auto-detect</option><option value="thai_id">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</option><option value="passport">‡∏û‡∏≤‡∏™‡∏õ‡∏≠‡∏£‡πå‡∏ï</option><option value="driver">‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà</option></select></div>
        <div class="col-6"><label>‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥</label><input type="text" id="nationality" placeholder="Thai / THA / ..." /></div>
        <div class="col-6"><label>‡∏ä‡∏∑‡πà‡∏≠ (EN)</label><input type="text" id="firstNameEn" placeholder="GIVEN NAME" /></div>
        <div class="col-6"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (EN)</label><input type="text" id="lastNameEn" placeholder="SURNAME" /></div>
        <div class="col-6"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (TH)</label><input type="text" id="fullNameTh" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" /></div>
        <div class="col-6"><label>‡πÄ‡∏û‡∏®</label><input type="text" id="gender" placeholder="M/F ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏≤‡∏¢/‡∏´‡∏ç‡∏¥‡∏á" /></div>
        <div class="col-6"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</label><input type="text" id="docNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å / Passport No." /></div>
        <div class="col-6"><label>‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ï‡∏£ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</label><input type="text" id="backId" placeholder="(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" /></div>
        <div class="col-6"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input type="text" id="dob" placeholder="YYYY-MM-DD ‡∏´‡∏£‡∏∑‡∏≠ DD/MM/YYYY" /></div>
        <div class="col-6"><label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="text" id="expiry" placeholder="YYYY-MM-DD ‡∏´‡∏£‡∏∑‡∏≠ DD/MM/YYYY" /></div>
        <div class="col-12"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><textarea id="address" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏• ‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"></textarea></div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="margin-bottom: 6px;">
        <span class="badge">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</span>
      </div>
      <div class="toolbar">
        <button class="btn" id="downloadCsv">‚¨áÔ∏è CSV</button>
        <button class="btn secondary" id="downloadJson">‚¨áÔ∏è JSON</button>
        <button class="btn" id="copyClipboard">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
      </div>
    </section>

    <section class="card">
      <div class="row" style="margin-bottom:6px;"><span class="badge">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå OCR (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö)</span></div>
      <textarea id="rawOcr" readonly></textarea>
    </section>
  </main>

  <div class="footer">
    <div class="wrap">
      <div class="row"><span class="badge">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡πá‡∏ß</span><span>1) ‡∏ñ‡πà‡∏≤‡∏¢/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î 2) ‡∏Å‡∏î <span class="kbd">‡πÄ‡∏£‡∏¥‡πà‡∏° OCR</span> 3) ‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≠‡∏£‡πå‡∏° 4) ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span></div>
      <div class="row"><span class="hint">* ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î Tesseract.js ‡∏à‡∏≤‡∏Å CDN</span></div>
    </div>
  </div>

  <script>
    // UI helpers
    const el = id => document.getElementById(id);
    const logBox = el('logBox'), statusText = el('statusText');
    function log(msg){ logBox.textContent += (logBox.textContent?'\\n':'') + msg; logBox.scrollTop = logBox.scrollHeight; }
    function status(msg){ statusText.textContent = msg; }

    const fileInput = el('fileInput');
    const previewImg = el('previewImg');
    const video = el('video');
    const canvas = el('canvas');
    const runBtn = el('runBtn');
    const openCam = el('openCam');
    const snapBtn = el('snapBtn');
    const clearBtn = el('clearBtn');
    const rawOcr = el('rawOcr');

    // --- Camera ---
    let stream = null;
    async function startCamera(){
      try{
        // iOS/Safari requires https or localhost; give helpful error if blocked
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
        await video.play();
        snapBtn.disabled = false;
        status('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°');
        log('üé• ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
      }catch(err){
        log('‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message + '\\n‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô HTTPS/‡∏ö‡∏£‡∏≤‡∏ß‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á');
      }
    }
    openCam.addEventListener('click', startCamera);

    snapBtn.addEventListener('click', ()=>{
      if(!video.srcObject){ return; }
      const w = video.videoWidth, h = video.videoHeight;
      if(!w || !h){ log('‚ö†Ô∏è ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'); return; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      previewImg.src = dataUrl;
      runBtn.disabled = false;
      status('‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏° OCR');
      log('üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    });

    // --- File Upload ---
    function loadFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => { previewImg.src = e.target.result; resolve(); };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f){ return; }
      try{
        await loadFile(f); // HEIC ‡∏ö‡∏ô iOS ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å Safari ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô <img> ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        runBtn.disabled = false;
        status('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏° OCR');
        log(`üìÑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå: ${f.name} (${Math.round(f.size/1024)} KB)`);
      }catch(err){
        log('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    // --- Clear ---
    clearBtn.addEventListener('click', ()=>{
      try{
        if(stream) stream.getTracks().forEach(t=>t.stop());
      }catch(_){}
      video.srcObject = null;
      previewImg.src = '';
      fileInput.value = '';
      rawOcr.value = '';
      logBox.textContent = '';
      runBtn.disabled = true;
      snapBtn.disabled = true;
      status('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°');
    });

    // --- OCR ---
    function ensureTesseractLoaded(){
      if(!window.Tesseract){
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Tesseract.js ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå');
      }
    }

    async function runOCR(){
      if(!previewImg.src){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô'); return; }
      ensureTesseractLoaded();
      status('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ OCR...'); log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR (eng+tha)');
      runBtn.disabled = true;
      try{
        const worker = await Tesseract.createWorker('eng+tha', 1, {
          logger: m => { if(m.status){ status(m.status + (m.progress?` ${(m.progress*100).toFixed(0)}%`:'')); } }
        });
        const { data } = await worker.recognize(previewImg);
        await worker.terminate();
        const text = (data && data.text) ? data.text : '';
        rawOcr.value = text;
        log('‚úÖ OCR ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        parseAndFill(text);
      }catch(err){
        log('‚ùå OCR ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message);
      }finally{
        runBtn.disabled = false;
        status('‡∏û‡∏£‡πâ‡∏≠‡∏°');
      }
    }
    runBtn.addEventListener('click', runOCR);

    // --- Parse & Fill (‡∏¢‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô) ---
    function toDateISO(s){
      if(!s) return '';
      s = s.replace(/[.]/g,'/').replace(/\s+/g,' ').trim();
      let m = s.match(/\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/);
      if(m){ const [_, d, mo, y] = m; return y+'-'+String(mo).padStart(2,'0')+'-'+String(d).padStart(2,'0'); }
      m = s.match(/\b(\d{4})[-/](\d{1,2})[-/](\d{1,2})\b/);
      if(m){ const [_, y, mo, d] = m; return y+'-'+String(mo).padStart(2,'0')+'-'+String(d).padStart(2,'0'); }
      return s;
    }
    function detectType(text){
      const t = text.toUpperCase();
      if(t.includes('P<') || (t.includes('<<') && /\n.*\n/.test(t))) return 'passport';
      if(/\b(\d\s?\d{4}\s?\d{5}\s?\d{2}\s?\d)\b|\b\d{13}\b/.test(text.replace(/[^0-9]/g,' '))) return 'thai_id';
      if(t.includes('DRIVING') || t.includes('LICENCE') || t.includes('DEPARTMENT OF LAND TRANSPORT')) return 'driver';
      return '';
    }
    function parseMRZ(text){
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      let l1 = '', l2 = '';
      for(let i=0;i<lines.length;i++){
        if(lines[i].length >= 40 && /[<A-Z0-9]/.test(lines[i])){ if(!l1) l1=lines[i]; else if(!l2){ l2=lines[i]; break; } }
      }
      if(!l1 || !l2) return null;
      l1 = l1.replace(/\s/g,''); l2 = l2.replace(/\s/g,'');
      const nationality = l1.substring(2,5).replace(/</g,'');
      const namePart = l1.substring(5);
      const [surnameRaw, givenRaw] = namePart.split('<<');
      const lastNameEn = (surnameRaw||'').replace(/</g,' ').trim();
      const firstNameEn = (givenRaw||'').replace(/</g,' ').trim();
      const passportNo = l2.substring(0,9).replace(/</g,'');
      const birth = l2.substring(13,19);
      const sex = l2.substring(20,21);
      const expiry = l2.substring(21,27);
      const yyMMddToISO = yymmdd => /^[0-9]{6}$/.test(yymmdd) ? ((yymmdd.substring(0,2)>='31'?'19':'20')+yymmdd.substring(0,2))+'-'+yymmdd.substring(2,4)+'-'+yymmdd.substring(4,6) : '';
      return { docType:'passport', nationality, firstNameEn, lastNameEn, docNumber: passportNo, dob: yyMMddToISO(birth), expiry: yyMMddToISO(expiry), gender: (sex==='F'?'F':(sex==='M'?'M':'')) };
    }
    function parseThaiID(text){
      const idMatch = text.replace(/[^0-9]/g,' ').match(/\b(\d{1}\s?\d{4}\s?\d{5}\s?\d{2}\s?\d)\b|\b(\d{13})\b/);
      const id = idMatch ? idMatch[0].replace(/\s/g,'') : '';
      let dob=''; const dob1 = text.match(/‡πÄ‡∏Å‡∏¥‡∏î[^0-9]*(\d{1,2}[\/.-]\d{1,2}[\/.-]\d{4})/); const dob2 = text.match(/Birth\s*Date[^0-9]*(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/i);
      if(dob1) dob=dob1[1]; else if(dob2) dob=dob2[1];
      const firstEn=(text.match(/GIVEN\s*NAME[:\s]*([A-Z' -]+)/i)||[, ''])[1].trim();
      const lastEn =(text.match(/SURNAME[:\s]*([A-Z' -]+)/i)||[, ''])[1].trim();
      const fullNameTh=(text.match(/‡∏ä‡∏∑‡πà‡∏≠[\s:]*([\u0E00-\u0E7F\s]+)\n/)||[, ''])[1].trim();
      return { docType:'thai_id', nationality:'THA', docNumber:id, firstNameEn:firstEn, lastNameEn:lastEn, fullNameTh, dob: toDateISO(dob) };
    }
    function parseDriver(text){
      const lic=(text.match(/(DL|LIC|‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï|Licence No\.?)[^A-Z0-9]*([A-Z0-9-]{6,})/i)||[,,''])[2];
      const exp=(text.match(/Expiry|‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏[^0-9]*(\d{1,2}[\/.-]\d{1,2}[\/.-]\d{2,4})/i)||[, ''])[1];
      const name=(text.match(/Name[:\s]*([A-Z' -]+)/i)||[, ''])[1];
      return { docType:'driver', nationality:'THA', docNumber: lic||'', expiry: toDateISO(exp), firstNameEn: name };
    }
    function fillForm(d){
      const set=(id,v)=>{ if(v) el(id).value=v; };
      set('docType', d.docType); set('nationality', d.nationality);
      set('firstNameEn', d.firstNameEn); set('lastNameEn', d.lastNameEn);
      set('fullNameTh', d.fullNameTh); set('gender', d.gender);
      set('docNumber', d.docNumber); set('backId', d.backId);
      set('dob', d.dob); set('expiry', d.expiry); set('address', d.address);
    }
    function parseAndFill(text){
      const forced = el('docType').value;
      let p=null, kind=forced||detectType(text);
      if(kind==='passport') p=parseMRZ(text);
      else if(kind==='thai_id') p=parseThaiID(text);
      else if(kind==='driver') p=parseDriver(text);
      else { p=parseMRZ(text)||parseThaiID(text)||parseDriver(text); }
      if(p){ fillForm(p); log('üß© ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: '+p.docType); }
      else { log('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á'); }
    }

    // Export
    function captureForm(){
      return {
        docType: el('docType').value, nationality: el('nationality').value,
        firstNameEn: el('firstNameEn').value, lastNameEn: el('lastNameEn').value,
        fullNameTh: el('fullNameTh').value, gender: el('gender').value,
        docNumber: el('docNumber').value, backId: el('backId').value,
        dob: el('dob').value, expiry: el('expiry').value, address: el('address').value
      };
    }
    function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); }
    el('downloadCsv').addEventListener('click', ()=>{ const d=captureForm(); const header=['docType','nationality','firstNameEn','lastNameEn','fullNameTh','gender','docNumber','backId','dob','expiry','address']; const row=header.map(k=>`"${String(d[k]||'').replace(/"/g,'""')}"`).join(','); download('ocr_data.csv', header.join(',')+'\n'+row+'\n'); });
    el('downloadJson').addEventListener('click', ()=>{ download('ocr_data.json', JSON.stringify(captureForm(),null,2)); });
    el('copyClipboard').addEventListener('click', async()=>{ const d=captureForm(); await navigator.clipboard.writeText(Object.entries(d).map(([k,v])=>`${k}: ${v||''}`).join('\n')); log('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß'); });

    // Warn if no Tesseract
    window.addEventListener('load', ()=>{
      setTimeout(()=>{
        if(!window.Tesseract){
          log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Tesseract.js ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å CDN');
        }else{
          log('‚ÑπÔ∏è ‡πÇ‡∏´‡∏•‡∏î Tesseract.js ‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ OCR');
        }
      }, 800);
    });
  </script>
  <!-- CDN (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</body>
</html>